services:

  # ============================================================
  # INFRASTRUCTURE
  # ============================================================

  discovery-server:
    build:
      context: infra/discovery-server
    image: ewm/discovery-server
    platform: linux/amd64
    container_name: discovery-server
    ports:
      - "8761:8761"
    environment:
      - EUREKA_INSTANCE_HOSTNAME=discovery-server

  config-server:
    build:
      context: infra/config-server
    image: ewm/config-server
    platform: linux/amd64
    container_name: config-server
    ports:
      - "8888:8888"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
    depends_on:
      discovery-server:
        condition: service_started

  gateway-server:
    build:
      context: infra/gateway-server
    image: ewm/gateway-server
    platform: linux/amd64
    container_name: gateway-server
    restart: on-failure
    ports:
      - "8080:8080"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=false
    depends_on:
      config-server:
        condition: service_started

  # ============================================================
  # KAFKA
  # ============================================================

  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
    healthcheck:
      test: "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ============================================================
  # DATABASES
  # ============================================================

  compilation-db:
    image: postgres:16.1
    container_name: compilation-db
    ports:
      - "6541:5432"
    environment:
      - POSTGRES_USER=explorewithme
      - POSTGRES_PASSWORD=explorewithme
      - POSTGRES_DB=explorewithme
    healthcheck:
      test: "pg_isready -q -d explorewithme -U explorewithme"
      interval: 5s
      timeout: 3s
      retries: 10

  event-db:
    image: postgres:16.1
    container_name: event-db
    ports:
      - "6542:5432"
    environment:
      - POSTGRES_USER=explorewithme
      - POSTGRES_PASSWORD=explorewithme
      - POSTGRES_DB=explorewithme
    healthcheck:
      test: "pg_isready -q -d explorewithme -U explorewithme"
      interval: 5s
      timeout: 3s
      retries: 10

  request-db:
    image: postgres:16.1
    container_name: request-db
    ports:
      - "6543:5432"
    environment:
      - POSTGRES_USER=explorewithme
      - POSTGRES_PASSWORD=explorewithme
      - POSTGRES_DB=explorewithme
    healthcheck:
      test: "pg_isready -q -d explorewithme -U explorewithme"
      interval: 5s
      timeout: 3s
      retries: 10

  user-db:
    image: postgres:16.1
    container_name: user-db
    ports:
      - "6544:5432"
    environment:
      - POSTGRES_USER=explorewithme
      - POSTGRES_PASSWORD=explorewithme
      - POSTGRES_DB=explorewithme
    healthcheck:
      test: "pg_isready -q -d explorewithme -U explorewithme"
      interval: 5s
      timeout: 3s
      retries: 10

  analyzer-db:
    image: postgres:16.1
    container_name: analyzer-db
    ports:
      - "6545:5432"
    environment:
      - POSTGRES_USER=explorewithme
      - POSTGRES_PASSWORD=explorewithme
      - POSTGRES_DB=explorewithme
    healthcheck:
      test: "pg_isready -q -d explorewithme -U explorewithme"
      interval: 5s
      timeout: 3s
      retries: 10

  # ============================================================
  # CORE SERVICES
  # ============================================================

  user-service:
    build:
      context: core/user-service
    image: ewm/user-service
    platform: linux/amd64
    container_name: user-service
    restart: on-failure
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:postgresql://user-db:5432/explorewithme
      - SPRING_DATASOURCE_USERNAME=explorewithme
      - SPRING_DATASOURCE_PASSWORD=explorewithme
    depends_on:
      config-server:
        condition: service_started
      user-db:
        condition: service_healthy

  event-service:
    build:
      context: core/event-service
    image: ewm/event-service
    platform: linux/amd64
    container_name: event-service
    restart: on-failure
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:postgresql://event-db:5432/explorewithme
      - SPRING_DATASOURCE_USERNAME=explorewithme
      - SPRING_DATASOURCE_PASSWORD=explorewithme
      - JAVA_TOOL_OPTIONS=-Dio.grpc.netty.shaded.io.netty.transport.noNative=true
    depends_on:
      config-server:
        condition: service_started
      event-db:
        condition: service_healthy

  request-service:
    build:
      context: core/request-service
    image: ewm/request-service
    platform: linux/amd64
    container_name: request-service
    restart: on-failure
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:postgresql://request-db:5432/explorewithme
      - SPRING_DATASOURCE_USERNAME=explorewithme
      - SPRING_DATASOURCE_PASSWORD=explorewithme
    depends_on:
      config-server:
        condition: service_started
      request-db:
        condition: service_healthy

  compilation-service:
    build:
      context: core/compilation-service
    image: ewm/compilation-service
    platform: linux/amd64
    container_name: compilation-service
    restart: on-failure
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:postgresql://compilation-db:5432/explorewithme
      - SPRING_DATASOURCE_USERNAME=explorewithme
      - SPRING_DATASOURCE_PASSWORD=explorewithme
      - JAVA_TOOL_OPTIONS=-Dio.grpc.netty.shaded.io.netty.transport.noNative=true
    depends_on:
      config-server:
        condition: service_started
      compilation-db:
        condition: service_healthy

  # ============================================================
  # STATS SERVICES
  # ============================================================

  collector:
    build:
      context: stats/collector
    image: ewm/collector
    platform: linux/amd64
    container_name: collector
    restart: on-failure
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=false
      - KAFKA_PRODUCER_PROPERTIES_BOOTSTRAP_SERVER=kafka:9092
      - JAVA_TOOL_OPTIONS=-Dio.grpc.netty.shaded.io.netty.transport.noNative=true
    depends_on:
      config-server:
        condition: service_started
      kafka:
        condition: service_healthy

  aggregator:
    build:
      context: stats/aggregator
    image: ewm/aggregator
    platform: linux/amd64
    container_name: aggregator
    restart: on-failure
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=false
      - SPRING_APPLICATION_JSON={"kafka":{"consumer":{"properties":{"bootstrap.servers":"kafka:9092"}},"producer":{"properties":{"bootstrap.servers":"kafka:9092"}}}}
    depends_on:
      config-server:
        condition: service_started
      kafka:
        condition: service_healthy

  analyzer:
    build:
      context: stats/analyzer
    image: ewm/analyzer
    platform: linux/amd64
    container_name: analyzer
    restart: on-failure
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:postgresql://analyzer-db:5432/explorewithme
      - SPRING_DATASOURCE_USERNAME=explorewithme
      - SPRING_DATASOURCE_PASSWORD=explorewithme
      - SPRING_APPLICATION_JSON={"kafka":{"similarity-consumer":{"properties":{"bootstrap.servers":"kafka:9092"}},"action-consumer":{"properties":{"bootstrap.servers":"kafka:9092"}}}}
      - JAVA_TOOL_OPTIONS=-Dio.grpc.netty.shaded.io.netty.transport.noNative=true
    depends_on:
      config-server:
        condition: service_started
      analyzer-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
